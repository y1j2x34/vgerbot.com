# 服务化拆分

## 什么时候拆分

项目初期为了快速上线、验证可行性，只开发部分基本功能。可行性经过验证，用户增多，需要更多功能，
这时候开始扩张开发人员来支撑多个功能的开发，这个时候如果继续采用单体应用架构，多个功能模块混杂在一起开发、测试和部署的话，
就会导致不同的功能之间相互影响，一次打包部署需要所有的功能都测试OK才能上线。

单体应用同时进行开发的人员超过一定人数（大概10人），就会遇到上面的问题，这时候就该考虑进行服务化拆分。

## 如何实施

### 拆分方式

#### 一、纵向拆分

纵向拆分就是从业务维度进行拆分。标准是按照业务的关联程度来决定，关联比较密切的业务适合拆分为一个微服务，
而功能相对比较独立的业务适合独立拆分为一个微服务。

#### 二、横向拆分

从公共且独立功能维度拆分，标准是按照是否有公共的被多个其它服务调用，且依赖的资源独立不与其它业务耦合。

### 做法

实际工作中应该是横向拆分和纵向拆分相结合的方式：

1. 首先手机整理公用的模块，将其进行服务化处理，这是横向拆分；
1. 其次根据不同业务之间的耦合程度，将相对独立的服务拆分到不同的服务中，这属于纵向拆分；

最后微服务列表中，既有被其他微服务使用的公共服务，也有彼此独立运行的业务服务。

### 考量

1. 业务维度聚类， 业务和数据关系密切的应该放在一起；
1. 功能维度聚类，公共功能聚合为一个服务；
1. 人员聚类，这是实际中的考量，如果某几个业务就几个人比较熟悉，那么最好放在一起。
1. 性能聚类，性能要求高的并发大的和性能要求低的并发小的，要分开为不同服务，这样部署和运行都独立，好维护。

## 前置条件

- 服务如何定义
    对于单体应用，不同功能模块之间的交互通常以类库的方式提供各个模块的功能，对于微服务来说，各个服务都运行在各自的进程之中，这时候可以通过接口向外界传达自己的信息，无论是何种通讯协议（HTTP/RPC），服务之间的调用都通过接口描述来约定，约定内容则包括：接口名、接口参数以及接口返回值；

- 服务如何发布和订阅
    单体应用由于部署在同一个WAR包里，接口之间的调用属于进程内调用，而拆分为微服务独立部署后，应该需要一个类似登记处的地方，能够记录每个服务提供者的地址以供服务调用者查询，在微服务架构里，这个地方就是**注册中心**

- 服务如何监控
    通常对于一个服务，我们关心的是QPS(调用量)、AvgTime(平均耗时)以及P999(99.9%的请求性能在多少毫秒以内)这些指标。这时候就需要一种通用的监控方案，能覆盖业务埋点、数据收集、数据处理、最后到数据展示的全链路功能；

- 服务如何治理
    拆分为微服务之后，服务数量变多了、依赖关系也变复杂。如果其中一个服务性能有问题，依赖的服务都势必会受到影响。这时候，可以设定一个调用性能阈值，如果一段时间内一直超过这个值，那么依赖服务的调用可以直接返回，这称为 熔断，也是服务治理的手段之一。

- 故障如何定位
    微服务的一次用户调用可能依赖多个服务，每个服务部署在不同的节点上，如果用户调用出现问题，这时候就需要一种解决方案能够将一次用户请求进行标记，并在多个依赖的服务系统中继续传递，以便串联所有路径，从而进行故障定位。

针对上述问题，必须有可行的解决方案后，才能进行进一步服务化拆分。

## 总结

无论是横向还是纵向拆分，都是将单体应用庞杂的功能进行拆分，抽离成单独的服务部署。

功能拆分不是越细越好，过度拆分会让服务数量膨胀变得难以管理。一般可以按照开发人员的总人数来决定。  